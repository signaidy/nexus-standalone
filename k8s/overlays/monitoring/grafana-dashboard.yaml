apiVersion: v1
kind: ConfigMap
metadata:
  name: nexus-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  nexus-8-panels.json: |
    {
      "title": "Nexus – Pipeline y Aplicación",
      "schemaVersion": 38,
      "version": 2,
      "panels": [
        {
          "type": "timeseries",
          "title": "Pipeline – Builds/min (Drone)",
          "gridPos": {"x":0, "y":0, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "increase(drone_build_count[5m]) / 300",
              "legendFormat": "ci (builds/s)",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Pipeline – Pending builds",
          "gridPos": {"x":12, "y":0, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "drone_pending_builds",
              "legendFormat": "ci",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Pipeline – Pending jobs",
          "gridPos": {"x":0, "y":8, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "drone_pending_jobs",
              "legendFormat": "ci",
              "refId": "A"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Pipeline – Repos registrados",
          "gridPos": {"x":12, "y":8, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "drone_repo_count",
              "refId": "A"
            }
          ]
        },

        {
          "type": "timeseries",
          "title": "App – RPS (front+back) por namespace",
          "gridPos": {"x":0, "y":16, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "sum by (namespace) ( rate(nexus_front_http_requests_total{namespace=~\"dev|uat|main\"}[5m]) ) + sum by (namespace) ( rate(http_server_requests_seconds_count{namespace=~\"dev|uat|main\"}[5m]) )",
              "legendFormat": "{{namespace}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "App – p95 latency (s) por namespace",
          "gridPos": {"x":12, "y":16, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "histogram_quantile(0.95, sum by (le, namespace) ( rate(nexus_front_http_request_duration_seconds_bucket{namespace=~\"dev|uat|main\"}[5m]) )) + histogram_quantile(0.95, sum by (le, namespace) ( rate(http_server_requests_seconds_bucket{namespace=~\"dev|uat|main\"}[5m]) ))",
              "legendFormat": "{{namespace}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "App – Error rate (5xx) por namespace",
          "gridPos": {"x":0, "y":24, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "sum by (namespace) ( rate(nexus_front_http_requests_total{namespace=~\"dev|uat|main\",status=~\"5..\"}[5m]) ) + sum by (namespace) ( rate(http_server_requests_seconds_count{namespace=~\"dev|uat|main\",status=~\"5..\"}[5m]) )",
              "legendFormat": "{{namespace}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "App – Apdex-ish (OK/total) por namespace",
          "gridPos": {"x":12, "y":24, "w":12, "h":8},
          "targets": [
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "(sum by (namespace) ( rate(nexus_front_http_requests_total{namespace=~\"dev|uat|main\",status!~\"5..\"}[5m]) ) / sum by (namespace) ( rate(nexus_front_http_requests_total{namespace=~\"dev|uat|main\"}[5m]) ))",
              "legendFormat": "front {{namespace}}",
              "refId": "A"
            },
            {
              "datasource": {"type":"prometheus","name":"Google Cloud Monitoring"},
              "editorMode": "code",
              "expr": "(sum by (namespace) ( rate(http_server_requests_seconds_count{namespace=~\"dev|uat|main\",status!~\"5..\"}[5m]) ) / sum by (namespace) ( rate(http_server_requests_seconds_count{namespace=~\"dev|uat|main\"}[5m]) ))",
              "legendFormat": "back {{namespace}}",
              "refId": "B"
            }
          ]
        }
      ]
    }