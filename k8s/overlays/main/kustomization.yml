apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: main
resources:
  - ../../base

images:
  - name: us-central1-docker.pkg.dev/spectra-kube/nexus/nexus-backend
    newTag: main
  - name: us-central1-docker.pkg.dev/spectra-kube/nexus/nexus-frontend
    newTag: main

configMapGenerator:
  - name: nexus-backend-config
    literals:
      - SPRING_PROFILES_ACTIVE=main
      - DB_URL=jdbc:oracle:thin:@//oracle.db.svc.cluster.local:1521/FREEPDB1
  - name: nexus-frontend-config
    literals:
      - VITE_API_URL=http://backend:8080

secretGenerator:
  - name: nexus-backend-secrets
    literals:
      - DB_USER=NEXUS_MAIN
      - DB_PASS=main_pass

generatorOptions:
  disableNameSuffixHash: true

patches:
  # Strategic-merge patch (YAML with apiVersion/kind) for env vars
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: backend
    path: backend-env.patch.yml

  # Strategic-merge patch to add the DB wait initContainer
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: backend
    path: backend-waitdb.patch.yml

  # JSON6902 patch to REPLACE probes with tcp sockets
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: backend
    path: backend-probes.jsonpatch.yml